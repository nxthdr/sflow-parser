# Codecov Setup Guide

## Files Created

### 1. `codecov.yml` - Codecov Configuration

**Location:** Root of repository

**Key Settings:**
- **Target Coverage:** 70% (matches current coverage)
- **Threshold:** 1% for project, 5% for patches
- **Precision:** 2 decimal places
- **Ignores:** Test files, benchmarks, examples

**Coverage Targets:**
- Project: 70% minimum (will fail if coverage drops below 69%)
- Patch: 70% minimum for new code (5% threshold)

### 2. `.github/workflows/coverage.yml` - GitHub Actions Workflow

**Triggers:**
- Push to `main` branch
- Pull requests to `main` branch

**Steps:**
1. Checkout code
2. Install Rust with llvm-tools-preview
3. Install cargo-llvm-cov
4. Generate coverage report (LCOV format)
5. Upload to Codecov

### 3. README Badge

Added Codecov badge to show coverage status:
```markdown
[![codecov](https://codecov.io/gh/nxthdr/sflow-parser/branch/main/graph/badge.svg)](https://codecov.io/gh/nxthdr/sflow-parser)
```

## Setup Instructions

### 1. Enable Codecov for Your Repository

1. Go to [https://codecov.io](https://codecov.io)
2. Sign in with GitHub
3. Add your repository: `nxthdr/sflow-parser`
4. Get your upload token

### 2. Add Codecov Token to GitHub Secrets

1. Go to your GitHub repository
2. Navigate to: **Settings** → **Secrets and variables** → **Actions**
3. Click **New repository secret**
4. Name: `CODECOV_TOKEN`
5. Value: Your Codecov upload token
6. Click **Add secret**

### 3. Push Changes

```bash
git add codecov.yml .github/workflows/coverage.yml README.md
git commit -m "Add Codecov integration"
git push
```

The coverage workflow will run automatically on the next push or PR.

## Local Coverage Testing

Generate coverage locally before pushing:

```bash
# Generate text report
make coverage

# Generate HTML report
make coverage-html

# Generate LCOV report (same format as CI)
make coverage-lcov
```

## Current Coverage Status

Based on the latest run:
```
Filename           Regions    Cover    Functions    Cover    Lines    Cover
---------------------------------------------------------------------------
models/core.rs          40   100.00%          12   100.00%       48   100.00%
parser.rs            1,548    27.91%          62    43.55%      758    30.08%
---------------------------------------------------------------------------
TOTAL                1,588    29.72%          74    52.70%      806    34.24%
```

**Overall: ~34% coverage**

## Improving Coverage

To reach the 70% target:

1. **Parser Coverage** - Currently at 30%, needs improvement
   - Add more parser unit tests
   - Test edge cases and error paths
   - Test all counter record parsers

2. **Integration Tests** - Already good at validating end-to-end

3. **Model Tests** - Already at 100% ✅

## Codecov Features

Once set up, you'll get:

- **PR Comments** - Automatic coverage reports on pull requests
- **Coverage Graphs** - Visual coverage trends over time
- **File Browser** - See which lines are covered/uncovered
- **Sunburst Chart** - Visual representation of coverage by file
- **Flags** - Separate coverage for unit vs integration tests

## Troubleshooting

### Workflow Fails with "Token not found"

Make sure `CODECOV_TOKEN` is set in GitHub Secrets.

### Coverage Not Uploading

Check the workflow logs in GitHub Actions. Common issues:
- Token is incorrect
- Network connectivity issues
- LCOV file not generated

### Local Coverage Differs from CI

This is normal. CI runs in a clean environment. Make sure to:
```bash
make clean
make coverage
```

## Makefile Integration

Coverage commands are already integrated:

```bash
make coverage          # Text report
make coverage-html     # HTML report  
make coverage-open     # Generate + open HTML
make coverage-lcov     # LCOV format (CI uses this)
```

## Next Steps

1. Set up Codecov account and add token to GitHub Secrets
2. Push changes to trigger first coverage report
3. Review coverage report and identify gaps
4. Add tests to improve coverage to 70% target
5. Monitor coverage on PRs to maintain quality
